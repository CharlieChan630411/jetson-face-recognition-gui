"""
face_detector_retina.py  â”€â”€ å–®å¼µæ¸¬è©¦ç‰ˆ
æ­¥é©Ÿï¼š
1. é€é insightface.model_zoo.RetinaFace ä¸‹è¼‰å®˜æ–¹ mnet0.25 æ¨¡å‹
2. è®€å–æ”å½±æ©Ÿå–®å¼µå½±åƒ
3. åµæ¸¬äººè‡‰ â†’ ç•«æ¡† â†’ å­˜æª” output_retina.jpg
"""

import cv2
from insightface.model_zoo import RetinaFace
import os, tempfile

# 1. ä¸‹è¼‰ / è¼‰å…¥å®˜æ–¹ RetinaFace æ¨¡å‹
print("ğŸš€ é‡æ–°ä¸‹è½½å®˜æ–¹ RetinaFace mnet025 æ¨¡å‹å¹¶æµ‹è¯•")

# ä¸´æ—¶ç›®å½•ï¼Œä¿è¯è‚¯å®šæ˜¯ç©ºçš„ï¼Œç¨‹åºä¼šè‡ªåŠ¨ä¸‹è½½æ­£ç¡®ç‰ˆæœ¬
temp_root = tempfile.mkdtemp()

def get_detector():
    from insightface.model_zoo import RetinaFace
    return RetinaFace(name="retinaface_mnet025_v2", root="~/.insightface")
    
detector = get_detector()
detector.prepare(ctx_id=0)   # ctx_id=0 â†’ CPUï¼›è‹¥ä¹‹å¾Œç”¨ GPU æ”¹ -1

# 2. è®€å–æ”å½±æ©Ÿå½±åƒ
cap = cv2.VideoCapture(0)
ret, frame = cap.read()
cap.release()

if not ret:
    raise RuntimeError("âŒ æ‘„å½±æœºç”»é¢ä¸ºç©º")

# âœ… åŠ å…¥é€™ä¸€è¡Œï¼šç¢ºèªå½±åƒå°ºå¯¸
print("frame.shape =", frame.shape)

# 3. åµæ¸¬äººè‡‰
faces, _ = detector.detect(frame, threshold=0.5, scale=1.0)
print(f"âœ… åµæ¸¬åˆ° {len(faces)} å¼µäººè‡‰")

# 4. ç•«æ¡†ä¸¦å­˜æª”
for x1, y1, x2, y2, *_ in faces:
    cv2.rectangle(frame, (int(x1), int(y1)), (int(x2), int(y2)), (0,255,0), 2)

cv2.imwrite("output_retina.jpg", frame)
print("ğŸ“¸ å·²è¼¸å‡º output_retina.jpg")

